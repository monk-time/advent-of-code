from inspect import cleandoc

import pytest

from year2020.aoc20 import (
    connect,
    fill_grid,
    find_monsters,
    parse,
    solve,
    stitch,
    verify_corners,
)

sample = cleandoc("""
    Tile 2311:
    ..##.#..#.
    ##..#.....
    #...##..#.
    ####.#...#
    ##.##.###.
    ##...#.###
    .#.#.#..##
    ..#....#..
    ###...#.#.
    ..###..###

    Tile 1951:
    #.##...##.
    #.####...#
    .....#..##
    #...######
    .##.#....#
    .###.#####
    ###.##.##.
    .###....#.
    ..#.#..#.#
    #...##.#..

    Tile 1171:
    ####...##.
    #..##.#..#
    ##.#..#.#.
    .###.####.
    ..###.####
    .##....##.
    .#...####.
    #.##.####.
    ####..#...
    .....##...

    Tile 1427:
    ###.##.#..
    .#..#.##..
    .#.##.#..#
    #.#.#.##.#
    ....#...##
    ...##..##.
    ...#.#####
    .#.####.#.
    ..#..###.#
    ..##.#..#.

    Tile 1489:
    ##.#.#....
    ..##...#..
    .##..##...
    ..#...#...
    #####...#.
    #..#.#.#.#
    ...#.#.#..
    ##.#...##.
    ..##.##.##
    ###.##.#..

    Tile 2473:
    #....####.
    #..#.##...
    #.##..#...
    ######.#.#
    .#...#.#.#
    .#########
    .###.#..#.
    ########.#
    ##...##.#.
    ..###.#.#.

    Tile 2971:
    ..#.#....#
    #...###...
    #.#.###...
    ##.##..#..
    .#####..##
    .#..####.#
    #..#.#..#.
    ..####.###
    ..#.#.###.
    ...#.#.#.#

    Tile 2729:
    ...#.#.#.#
    ####.#....
    ..#.#.....
    ....#..#.#
    .##..##.#.
    .#.####...
    ####.#.#..
    ##.####...
    ##..#.##..
    #.##...##.

    Tile 3079:
    #.#.#####.
    .#..######
    ..#.......
    ######....
    ####.#..#.
    .#...#.##.
    #.#####.##
    ..#.###...
    ..#.......
    ..#.###...
""")


@pytest.fixture(scope='module')
def grid():
    tiles = list(parse(sample))
    return fill_grid(connect(tiles))


@pytest.fixture(scope='module')
def tile(grid):
    return stitch(grid)


def test_fill_grid(grid):
    assert [[tile.id for tile in row] for row in grid] == [
        [2971, 1489, 1171],
        [2729, 1427, 2473],
        [1951, 2311, 3079],
    ]


def test_verify_corners(grid):
    assert verify_corners(grid) == 20899048083289


def test_stitch(tile):
    expected = cleandoc("""
        ...###...##...#...#..###
        .#.###..##..##..####.##.
        #.##..#..#...#..####...#
        #####..#####...###....##
        #..####...#.#.#.###.###.
        ..#.#..#..#.#.#.####.###
        .####.###.#...###.#..#.#
        .#.#.###.##.##.#..#.##..
        ###.#...#..#.##.######..
        .#.#....#.##.#...###.##.
        ...#..#..#.#.##..###.###
        ##..##.#...#...#.#.#.#..
        #.####....##..########.#
        ###.#.#...#.######.#..##
        #.####..#.####.#.#.###..
        #..#.##..#..###.#.##....
        .####...#..#.....#......
        ....#..#...##..#.#.###..
        ...########.#....#####.#
        ##.#....#.##.####...#.##
        ###.#####...#.#####.#..#
        ##.##.###.#.#..######...
        ###....#.#....#..#......
        .#.#..#.##...#.##..#####
    """).splitlines()
    assert tile.data == tuple(expected)


def test_find_monsters(tile):
    assert find_monsters(tile) == 273


def test_solve():
    assert solve() == (2699020245973, 2012)
